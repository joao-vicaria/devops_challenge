apiVersion: v1
kind: Pod
metadata:
  name: nameko-test
  namespace: nameko
spec:
#  initContainer:
#    - name: run-py
#      image: python:3.7.17-alpine
#      command: ['python', '-c']
#      args:
#        - |
#          import psycopg2 as db
#          p=postgres
#          con=db.connect(dbname=p,host=x1e2860a294caa5e6507abe673a53-postgresql-hl.nameko.svc.cluster.local:5432,user=p,password=8vKe5tZJRu
#          con.autocommit=True
#          con.cursor().execute('CREATE DATABASE orders') 2> /dev/null
  containers:
    - name: nameko-app
      env:
        - name: PORT
          value: "8080"
      image: 127.0.0.1:30500/apps/nameko-nameko:02448d2977911e75
      imagePullPolicy: Always
      ports:
      - containerPort: 8080
        protocol: TCP
      resources: {}
      terminationMessagePath: /dev/termination-log
      terminationMessagePolicy: File
      volumeMounts:
      - mountPath: /configurations/nameko-cfg
        name: nameko-cfg
        readOnly: true
      - mountPath: /configurations/nameko_devPostgres
        name: x1e2860a294caa5e6507abe673a53-postgresql
        readOnly: true
  dnsPolicy: ClusterFirst
  restartPolicy: Always
  schedulerName: default-scheduler
  securityContext: {}
  serviceAccount: nameko
  serviceAccountName: nameko
  volumes:
  - name: nameko-cfg
    secret:
      defaultMode: 420
      secretName: nameko-cfg
  - name: x1e2860a294caa5e6507abe673a53-postgresql
    secret:
      defaultMode: 420
      secretName: x1e2860a294caa5e6507abe673a53-postgresql
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
  name: nameko-test
  namespace: nameko
spec:
  internalTrafficPolicy: Cluster
  ipFamilies:
  - IPv4
  ipFamilyPolicy: SingleStack
  ports:
  - port: 8080
    protocol: TCP
    targetPort: 8080
  selector:
    app.kubernetes.io/component: application
    app.kubernetes.io/name: nameko
  sessionAffinity: None
  type: ClusterIP
#---
#apiVersion: networking.k8s.io/v1
#kind: Ingress
#metadata:
#  annotations:
#    traefik.ingress.kubernetes.io/router.entrypoints: websecure
#    traefik.ingress.kubernetes.io/router.tls: "true"
#  name: nameko-test
#  namespace: nameko
#spec:
#  ingressClassName: traefik
#  rules:
#  - host: nameko.172.18.0.2.sslip.io
#    http:
#      paths:
#      - backend:
#          service:
#            name: nameko-test
#            port:
#              number: 8080
#        path: /
#        pathType: ImplementationSpecific
#  tls:
#  - hosts:
#    - nameko.172.18.0.2.sslip.io
#    secretName: rnameko-nameko1721802s-0563611694e6aee6d1184da7647912b23c289d59